# Проект на FastAPI

## Описание
Проект представляет собой веб-приложение, разработанное с использованием фреймворка FastAPI.
Приложение предоставляет API для небольшого онлайн-магазина.

## Технологии
- **FastAPI**: Фреймворк для создания высокопроизводительных веб-приложений на Python 3.7+.
- **Uvicorn**: ASGI-сервер для запуска приложения.
- **Pytest**: Инструмент для тестирования.
- **Git**: Система контроля версий.

## Установка

1. **Клонируйте репозиторий:**
   ```bash
   git clone https://github.com/ваш_репозиторий.git
   cd ваш_репозиторий
   ```

2. **Создайте и активируйте виртуальное окружение:**
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Linux/macOS
   # или
   .venv\Scripts\activate    # Windows PowerShell
   ```

3. **Установите зависимости:**
   ```bash
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

4. **Настройте переменные окружения:**
   Проект использует Redis в качестве брокера Celery и PostgreSQL для базы данных. Приложение ожидает, что строка подключения к базе данных будет передана через переменную окружения `DATABASE_URL`, иначе запуск завершится с понятной ошибкой.
   Скопируйте файл `.env.example` в `.env`, задайте собственные значения и выполните `source .env`. В примере собраны ключевые переменные:
   ```bash
   SECRET_KEY="..."                # секрет для подписи JWT
   SESSION_SECRET="..."            # секрет сессий Starlette
   CELERY_BROKER_URL="redis://localhost:6379/0"
   CELERY_RESULT_BACKEND="redis://localhost:6379/0"
   CORS_ORIGINS="https://example.com,https://another.example"  # разделитель - запятая
   DATABASE_URL="postgresql+asyncpg://ecommerce:1234@localhost:5432/ecommerce"
   ```

   Убедитесь, что сервисы Redis и PostgreSQL доступны по указанным адресам или укажите свои значения. Для production-окружения обязательно замените секреты на уникальные.
5. **Примените миграции базы данных:**
   Выполняйте команды из корня проекта. Если используется Alembic по умолчанию, достаточно запустить:

   ```bash
   alembic upgrade head
   ```

6. **Запустите сервер разработки:**
   ```bash
   uvicorn app.main:app --reload
   ```

## Запуск Celery-воркера

Для выполнения фоновых задач запустите Celery-воркер в отдельном процессе после настройки переменных окружения:

```bash
celery -A app.main.celery worker --loglevel=info
```

При необходимости укажите параметры подключения к брокеру и бекенду через переменные окружения, чтобы они совпадали с настройками Redis.


## Проверка деактивации пользователя через Swagger

1. Запустите сервер разработки (`uvicorn app.main:app --reload`) и откройте интерфейс документации по адресу `http://localhost:8000/docs`.
2. Авторизуйтесь с учетной записью администратора, получив JWT-токен через эндпоинт `/v1/auth/login` и передав его в Swagger через кнопку **Authorize**.
3. Найдите эндпоинт `DELETE /v1/permission/delete`, нажмите **Try it out** и передайте `user_id` пользователя, которого требуется удалить.
4. Выполните запрос — в ответе ожидайте сообщение о том, что пользователь успешно удален.
5. Повторно выполните запрос `GET /v1/users/{user_id}` (или другой доступный эндпоинт получения профиля) и убедитесь, что поле `is_active` стало `false` или пользователь больше не возвращается активным.
{% extends "admin/base.html" %}
{% block title %}Вход администратора{% endblock %}
{% block content %}
<div class="card">
  <h1>Вход администратора</h1>
  <p>Укажите логин и пароль администратора, чтобы получить доступ к управлению пользователями.</p>
  <form id="login-form">
    <label>
      <span>Логин</span>
      <input type="text" name="username" autocomplete="username" required>
    </label>
    <label>
      <span>Пароль</span>
      <input type="password" name="password" autocomplete="current-password" required>
    </label>
    <button type="submit" class="button primary">Войти</button>
  </form>
  <div id="login-error" class="feedback error" style="display:none;"></div>
</div>
<script>
  const form = document.getElementById("login-form");
  const errorBox = document.getElementById("login-error");

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    errorBox.style.display = "none";
    const formData = new FormData(form);
    const username = formData.get("username");
    const password = formData.get("password");
    const token = btoa(`${username}:${password}`);

    try {
      const response = await fetch("/admin/login", {
        method: "POST",
        headers: { "Authorization": `Basic ${token}` },
        credentials: "include"
      });

      if (response.ok) {
        window.location.href = "/admin/users";
        return;
      }

      let message = "Не удалось выполнить вход.";
      try {
        const payload = await response.json();
        if (payload.detail) {
          message = payload.detail;
        }
      } catch (error) {
        console.error(error);
      }
      errorBox.textContent = message;
      errorBox.style.display = "block";
    } catch (error) {
      errorBox.textContent = "Ошибка сети. Попробуйте ещё раз.";
      errorBox.style.display = "block";
    }
  });
</script>
{% endblock %}

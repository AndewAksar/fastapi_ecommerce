# Каталог эндпоинтов FastAPI

Документ описывает публичные и служебные маршруты приложения. Все эндпоинты живут под версией `/v1`, если не указано иное. Для вызовов, требующих авторизации, необходимо передавать Bearer-токен, полученный через `/v1/auth/token`.

## Общие зависимости
- `Depends(get_db)` — создаёт асинхронную сессию SQLAlchemy.
- `Depends(get_current_user)` — извлекает информацию о пользователе из JWT. Возвращает словарь с флагами ролей (`is_admin`, `is_supplier`, `is_customer`). При ошибке токена возвращает HTTP 401/400.
- Для административных операций проверяется `is_admin`, для поставщиков — `is_supplier`.

## Auth (`/v1/auth`)
| Метод и путь | Назначение | Тело запроса | Ответ | Требования |
| --- | --- | --- | --- | --- |
| `POST /` | Регистрация пользователя. | `CreateUser` (имя, логин, email, пароль). | 201 + сообщение об успехе. | Открытый доступ. |
| `POST /token` | Получение JWT по паре логин/пароль. | `application/x-www-form-urlencoded` (`username`, `password`). | JSON с `access_token`, `type_token`. | Открытый доступ. |
| `GET /read_current_user` | Возврат payload текущего токена. | — | Информация о пользователе. | Требуется валидный Bearer. |

**Особенности:** срок действия токена жёстко задан (15 минут). Секрет хранится в коде. Ошибки валидации возвращают 401/400.

## Categories (`/v1/category`)
| Метод и путь | Назначение | Тело запроса | Ответ | Требования |
| --- | --- | --- | --- | --- |
| `GET /` | Получить все активные категории. | — | Список `Category`. | Открытый доступ. |
| `POST /` | Создать категорию. | `CreateCategory` (`name`, `parent_id`). | 201 + статус. | Только админ. |
| `PUT /{category_slug}` | Обновить имя/родителя категории. | `CreateCategory`. | 200 + статус. | Только админ. |
| `DELETE /{category_slug}` | Пометить категорию как неактивную. | — | 200 + статус. | Только админ. |

**Известные ограничения:**
- Обновление/удаление работают с объектом, полученным через `db.scalars(... )`. Возвращаемое значение — `ScalarResult`; в коде используется напрямую, поэтому перед фактическим доступом нужно вызвать `.first()` или распаковать результат.

## Products (`/v1/products`)
| Метод и путь | Назначение | Тело запроса | Ответ | Требования |
| --- | --- | --- | --- | --- |
| `GET /` | Получить активные товары со складом > 0. | — | Список `Product`. | Открытый доступ. |
| `POST /` | Создать товар. | `CreateProduct`. | 201 + статус. | Админ или поставщик. |
| `GET /{category_slug}` | Получить товары категории и её подкатегорий. | — | Список `Product`. | Открытый доступ. |
| `GET /detail/{product_slug}` | Получить детальную карточку товара. | — | `Product`. | Открытый доступ. |
| `PUT /{product_slug}` | Обновить товар. | `CreateProduct`. | 200 + статус. | Админ или владелец-поставщик. |
| `DELETE /{product_slug}` | Деактивировать товар. | — | 200 + статус. | Админ или владелец-поставщик. |

**Особенности:**
- Для `POST`/`PUT` проверяется существование категории.
- `PUT`/`DELETE` используют проверку ролей через флаги пользователя. В исходном коде используется `db.scalars(...)` без `.first()`, что нужно учитывать при расширении логики.

## Reviews (`/v1/reviews`)
| Метод и путь | Назначение | Тело запроса | Ответ | Требования |
| --- | --- | --- | --- | --- |
| `GET /` | Получить активные отзывы. | — | Список `Review`. | Открытый доступ. |
| `GET /{product_slug}` | Отзывы по слагу товара. | — | Список `Review`. | Открытый доступ. |
| `POST /` | Добавить отзыв и обновить рейтинг товара. | `CreateReview`. | 201 + статус. | Любой авторизованный пользователь. |
| `DELETE /{review_id}` | Деактивировать отзыв. | — | 200 + статус. | Только админ. |

**Особенности:**
- При создании отзыва выполняется проверка на дубликаты от того же пользователя и пересчёт рейтинга товара через `func.count`.
- Код предполагает, что `review_count` возвращает количество активных отзывов, но не учитывает `None` и деление на ноль — добавляя новые сценарии, проверяйте краевые случаи.

## Permission (`/v1/permission`)
| Метод и путь | Назначение | Тело запроса | Ответ | Требования |
| --- | --- | --- | --- | --- |
| `PATCH /` | Переключить роль пользователя между поставщиком и клиентом. | query `user_id`. | 200 + статус. | Только админ. |
| `DELETE /delete` | Шаблон удаления пользователя (без фактического удаления). | query `user_id`. | 200 + статус. | Только админ. |

**Особенности:** при отсутствии пользователя возвращает 404. В ответах присутствует жёстко заданный текст; для прод-версии рекомендуется переписать сообщения.

## Sessions (`/v1/sessions`)
| Метод и путь | Назначение | Тело запроса | Ответ | Требования |
| --- | --- | --- | --- | --- |
| `GET /create_session` | Сохранить значение `my_session` в сессии. | — | `'ok'`. | Открытый доступ. |
| `GET /read_session` | Прочитать значение `my_session`. | — | Значение или `null`. | Открытый доступ. |
| `GET /delete_session` | Удалить и вернуть значение `my_session`. | — | Ранее сохранённое значение. | Открытый доступ. |

## Веб-сокеты и фоновые задачи
- Веб-сокеты реализованы в `app/connection_manager.py` и используются для широковещательных сообщений. URL объявляется в `main.py` (подписчики получают события).
- Фоновая задача `call_background_task` размещена в Celery и вызывается стартовой страницей `/v1/`.

## Админ-панель
- FastAdmin смонтирован на `/admin`. Использует модели `User`, `Product`, `Category`, `Review`.

## Практические советы
- Для клиентского тестирования удобно использовать `http://localhost:8000/docs` — включена стандартная OpenAPI-схема.
- Все эндпоинты возвращают словари/списки SQLAlchemy-моделей без Pydantic сериализации. При разработке клиентской части учитывайте прямой вывод ORM-объектов (не JSON сериализуем без настройки). Для прод-использования необходимо добавить схему ответа или включить `response_model`.

# Руководство для ИИ-агента

## Краткое описание
Проект реализует учебное e-commerce API на FastAPI. Основное приложение `app/main.py` инициализирует FastAPI-приложение, регистрирует админ-панель FastAdmin, подключает middleware для логирования и замеров времени, а также настраивает Celery для фоновых задач и веб-сокеты для push-уведомлений.

## Архитектура и жизненный цикл
1. **Старт приложения**
   - Логирование конфигурируется через `app.logging_config.configure_logging()`.
   - Главный `FastAPI`-инстанс объявляется с метаданными и монтирует админку (`/admin`).
   - Создаётся Celery-приложение с Redis (локальный брокер и бекенд по умолчанию) и планировщиком `beat`.
   - Подключаются middleware: собственный `TimingMiddleWare`, логирующий `log_middleware` и дополнительные из `app.middleware` (CORS и т. п.).
   - `setup_routers(app)` монтирует подприложение `/v1` с версионированными API-роутами.

2. **Версионированное API (`/v1`)**
   - Создаётся отдельный FastAPI-приложение `app_v1`.
   - `app_v1` регистрирует роутеры из `app.routers.v1`: `auth`, `category`, `permission`, `products`, `reviews`, `session`.
   - Корневой обработчик `/v1/` асинхронно ставит в очередь Celery-задачу `call_background_task`.

3. **Фоновые задачи**
   - `app/tasks.py` содержит Celery-задачу `call_background_task`, имитирующую долгую работу (sleep) и логирующую сообщения.
   - Планировщик Celery Beat периодически вызывает задачу каждые 6 секунд с тестовым сообщением.

4. **Работа с БД**
   - `app/backend/db.py` объявляет `async_session_maker` и базовый класс SQLAlchemy (`DeclarativeBase`) с использованием драйвера `asyncpg`.
   - Параметры подключения зашиты в коде (PostgreSQL контейнер `db`). Для реального деплоя требуется вынести в переменные окружения.
   - `app/backend/db_depends.py` определяет зависимость `get_db` для получения `AsyncSession`.
   - SQLAlchemy-модели в `app/models` описывают сущности `Category`, `Product`, `Review`, `User` с отношениями. В некоторых файлах включена отладочная печать `CreateTable` — учтите это при запуске.

5. **Роутеры**
   - Каждый модуль в `app/routers/v1` использует зависимости из `app.backend` и Pydantic-схемы из `app.schemas`.
   - Реализованы CRUD-операции для категорий, продуктов, отзывов, а также авторизация и управление правами. Тестовые данные и бизнес-логика в текущей версии минимальны.

6. **Прочее**
   - `app/templates` содержит Jinja2-шаблоны для HTML-страниц (`index.html`, `redirect.html`).
   - `app/connection_manager.py` управляет веб-сокетами для трансляции сообщений всем подключённым клиентам.
   - `app/admin.py` настраивает модели для FastAdmin.

## Запуск и инфраструктура
- **Development**: `uvicorn app.main:app --reload`.
- **Celery**: `celery -A app.main.celery worker --loglevel=info` плюс опционально `celery -A app.main.celery beat`.
- **Docker**: присутствуют `docker-compose.yml` и `docker-compose.prod.yml` для локальной и прод конфигураций (web, db, redis, celery).
- **Статическая проверка**: тестов/линтеров в репозитории нет, но можно добавить Pytest, Ruff, MyPy.

## Особенности и предупреждения
- Подключение к БД и Redis жёстко задано в коде — при изменении инфраструктуры обязательно обновите конфигурацию.
- Некоторые модели (`app/models/category.py`) печатают DDL при импорте. Это приводит к шуму в логах и может тормозить cold start.
- FastAdmin и Celery требуют соответствующих зависимостей из `requirements.txt`.

## Советы для доработок
- Вынести конфиги (DB, Redis, Celery) в `.env` и использовать Pydantic Settings.
- Добавить миграции (Alembic) и тесты для основных сценариев.
- Расширить схемы в `app/schemas.py` и привести модели к Pydantic v2.
- Обновить middleware и безопасность (rate limiting, CSRF для форм, CORS настройки).

Это руководство распространяется на весь репозиторий.
